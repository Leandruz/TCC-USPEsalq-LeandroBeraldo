from google.cloud import bigquery
import pandas as pd
import re

client = bigquery.Client()

query = """
SELECT *
FROM `tcc-usp-445616.sinasc.SINASC_PR_2014_2023`
"""
df = client.query(query).to_dataframe()

def separar_cid(codigo_anomalia):
    if pd.isna(codigo_anomalia):
        return []
    return re.findall(r'[A-Z]\d{2,4}', codigo_anomalia)

df_cids = df.copy()
df_cids['cids_separados'] = df_cids['codigo_anomalia'].apply(separar_cid)

max_cids = df_cids['cids_separados'].map(len).max()
for i in range(max_cids):
    df_cids[f'codigo_anomalia_{i+1}'] = df_cids['cids_separados'].apply(lambda x: x[i] if i < len(x) else None)

df_cids.drop(columns=['cids_separados'], inplace=True)

table_id = "tcc-usp-445616.sinasc.SINASC_PR_2014_2023_processada"

job_config = bigquery.LoadJobConfig(
    write_disposition=bigquery.WriteDisposition.WRITE_TRUNCATE
)
job = client.load_table_from_dataframe(df_cids, table_id, job_config=job_config)
job.result()

print(f"Os dados processados foram salvos na tabela {table_id}.")
